<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>P2 | Working Summary (Cloud Sync)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --danger:#dc2626;
  --success:#10b981;
  --radius:14px;
  --shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:linear-gradient(180deg,#eef5ff,#f8fafc);
  color:var(--text);
}
.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{
  width:270px;
  background:linear-gradient(180deg,var(--primary),var(--primary-dark));
  color:#fff;
  padding:24px 18px;
}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:30px}
.logo{
  width:44px;height:44px;border-radius:12px;
  background:#fff;color:var(--primary);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:20px;
}
.nav a{
  display:flex;gap:12px;align-items:center;
  padding:12px 14px;border-radius:10px;
  text-decoration:none;color:#fff;font-weight:600;
  opacity:.85;margin-bottom:4px;
}
.nav a.active,.nav a:hover{background:rgba(255,255,255,.2);opacity:1}

/* MAIN */
.main{flex:1;padding:26px;overflow:auto}
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px}
.page-title{font-size:22px;font-weight:800}

.sync-status{
  display:flex;align-items:center;gap:8px;
  background:#fff;padding:6px 14px;border-radius:30px;
  border:1px solid var(--border);font-size:12px;font-weight:600;
}
.dot{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
.dot.online{background:var(--success);box-shadow:0 0 8px var(--success)}

.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:22px}
.kpi{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
.kpi h4{margin:0;font-size:13px;color:var(--muted)}
.kpi .val{font-size:28px;font-weight:800;margin-top:6px;color:var(--primary)}

.card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
.table-wrap{border:1px solid var(--border);border-radius:12px;overflow:auto}
table{width:100%;border-collapse:collapse;min-width:800px}
thead th{background:#f1f5f9;padding:14px;font-size:13px;color:var(--muted);text-align:left}
tbody td{padding:14px;border-top:1px solid var(--border);font-size:14px}

.btn{
  padding:8px 12px;border-radius:8px;border:none;
  font-weight:700;font-size:12px;cursor:pointer;
  display:inline-flex;gap:6px;align-items:center;transition:0.2s;
}
.btn-ghost{background:#f1f5f9;color:var(--primary)}
.btn-ghost:hover{background:#e2e8f0}
.btn-success{background:#dcfce7;color:var(--success)}
.remark-text{font-style:italic;color:var(--muted);font-size:12px}
</style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">P1</div>
      <div><div style="font-weight:700">Follow-Up</div><div style="font-size:12px;opacity:.8">Control</div></div>
    </div>
    <nav class="nav">
      <a href="index.html"><i class="fa fa-plus"></i> New Entry</a>
      <a class="active" href="page2.html"><i class="fa fa-list-check"></i> Working Summary</a>
      <a href="page3.html"><i class="fa fa-chart-line"></i> Analytics</a>
      <a href="page4.html"><i class="fa fa-check-circle"></i> Completed</a>
      <a href="page5.html"><i class="fa fa-triangle-exclamation"></i> Backlogs</a>
      <a href="page6.html"><i class="fa fa-cubes"></i> WallDrop</a>
    </nav>
  </aside>

  <main class="main">
    <div class="page-header">
      <div class="page-title">Working Summary</div>
      <div class="sync-status">
        <div id="syncDot" class="dot"></div>
        <span id="syncText">Syncing...</span>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><h4>Today's Tasks</h4><div class="val" id="kToday">0</div></div>
      <div class="kpi"><h4>Upcoming</h4><div class="val" id="kUpcoming">0</div></div>
      <div class="kpi"><h4>Current Overdue</h4><div class="val" id="kBack">0</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;margin-bottom:15px">
        <h3 style="margin:0">Active Follow-Ups</h3>
        <button class="btn btn-ghost" onclick="exportExcel()"><i class="fa fa-file-excel"></i> Export</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Jobcard</th>
              <th>Type</th>
              <th>Follow-Up Date</th>
              <th>Latest Remark</th>
              <th>Status</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<script>
const API_URL = "/api";
let records = [];

function parseDate(str){
  if(!str) return null;
  const p = str.split(" ")[0].split("/");
  return new Date(p[2], p[1]-1, p[0]);
}

// --- CLOUD SYNC ---

async function loadCloudData() {
  try {
    const res = await fetch(API_URL);
    records = await res.json();
    document.getElementById('syncDot').className = "dot online";
    document.getElementById('syncText').innerText = "Cloud Active";
    render();
  } catch (e) {
    document.getElementById('syncDot').className = "dot";
    document.getElementById('syncText').innerText = "Sync Error";
  }
}

async function updateCloudRecord(r) {
  await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(r)
  });
  loadCloudData();
}

// --- ACTIONS ---

function addRemark(jobcard) {
  const r = records.find(x => x.jobcard === jobcard);
  const msg = prompt("Enter Remark:", r.remark || "");
  if (msg === null) return;
  r.remark = msg;
  updateCloudRecord(r);
}

function editFollow(jobcard) {
  const r = records.find(x => x.jobcard === jobcard);
  const newDate = prompt("Enter New Date (DD/MM/YYYY HH:MM:SS):", r.todayFollow);
  if (!newDate) return;
  r.todayFollow = newDate;
  updateCloudRecord(r);
}

function postpone(jobcard) {
  const r = records.find(x => x.jobcard === jobcard);
  const days = parseInt(prompt("Postpone by how many days?", "1"));
  if (isNaN(days)) return;

  const d = parseDate(r.todayFollow) || new Date();
  d.setDate(d.getDate() + days);
  
  const pad = n => n.toString().padStart(2, '0');
  r.todayFollow = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} 09:00:00`;
  r.status = "Postponed";
  r.postponeIndex = (r.postponeIndex || 0) + 1;
  
  updateCloudRecord(r);
}

function complete(jobcard) {
  if (!confirm("Move to Completed?")) return;
  const r = records.find(x => x.jobcard === jobcard);
  r.status = "Completed";
  
  const d = new Date();
  const pad = n => n.toString().padStart(2, '0');
  r.completedAt = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  
  updateCloudRecord(r);
}

// --- RENDERING ---

function render() {
  const active = records.filter(r => r.status !== 'Completed');
  const now = new Date(); now.setHours(0,0,0,0);
  
  let today = 0, up = 0, back = 0;
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = "";

  active.forEach(r => {
    const d = parseDate(r.todayFollow);
    if (d) {
      d.setHours(0,0,0,0);
      if (d.getTime() === now.getTime()) today++;
      else if (d > now) up++;
      else back++;
    }

    tbody.innerHTML += `
      <tr>
        <td><b>${r.jobcard}</b></td>
        <td>${r.type}</td>
        <td>${r.todayFollow}</td>
        <td><span class="remark-text">${r.remark || "-"}</span></td>
        <td><span class="rack-badge">${r.status || "Active"}</span></td>
        <td style="text-align:right">
          <button class="btn btn-ghost" onclick="addRemark('${r.jobcard}')"><i class="fa fa-comment"></i></button>
          <button class="btn btn-ghost" onclick="editFollow('${r.jobcard}')">Edit</button>
          <button class="btn btn-ghost" onclick="postpone('${r.jobcard}')">Postpone</button>
          <button class="btn btn-success" onclick="complete('${r.jobcard}')"><i class="fa fa-check"></i> Done</button>
        </td>
      </tr>`;
  });

  document.getElementById('kToday').innerText = today;
  document.getElementById('kUpcoming').innerText = up;
  document.getElementById('kBack').innerText = back;
}

function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(records.filter(r => r.status !== 'Completed'));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Active_Jobs");
  XLSX.writeFile(wb, "Cloud_Working_Summary.xlsx");
}

// Initial load & Auto-refresh every 30s
loadCloudData();
setInterval(loadCloudData, 30000);
</script>
</body>
</html>