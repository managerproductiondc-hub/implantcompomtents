<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>P3 | Analytics (Cloud Sync)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --radius:14px;
  --shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  color:var(--text);
}
.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{
  width:270px;
  background:linear-gradient(180deg,var(--primary),var(--primary-dark));
  color:#fff;
  padding:24px 18px;
}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:30px}
.logo{
  width:44px;height:44px;border-radius:12px;
  background:#fff;color:var(--primary);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:20px;
}
.nav a{
  display:flex;gap:12px;align-items:center;
  padding:12px 14px;border-radius:10px;
  text-decoration:none;color:#fff;font-weight:600;
  opacity:.85;margin-bottom:4px;
}
.nav a.active,.nav a:hover{background:rgba(255,255,255,.2);opacity:1}

/* MAIN */
.main{flex:1;padding:26px;overflow:auto}
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px}
.page-title{font-size:22px;font-weight:800}

.sync-status{
  display:flex;align-items:center;gap:8px;
  background:#fff;padding:6px 14px;border-radius:30px;
  border:1px solid var(--border);font-size:12px;font-weight:600;
}
.dot{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
.dot.online{background:#10b981;box-shadow:0 0 8px #10b981}

.chart-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));
  gap:22px;
}
.chart-card{
  background:var(--card);
  padding:24px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}
.chart-card h3{margin:0 0 20px 0; font-size:16px; color:var(--muted)}
canvas{max-width:100%; height:300px !important;}

@media(max-width:768px){ .chart-grid{grid-template-columns:1fr} }
</style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">P1</div>
      <div><div style="font-weight:700">Follow-Up</div><div style="font-size:12px;opacity:.8">Control</div></div>
    </div>
    <nav class="nav">
      <a href="index.html"><i class="fa fa-plus"></i> New Entry</a>
      <a href="page2.html"><i class="fa fa-list-check"></i> Working Summary</a>
      <a class="active" href="page3.html"><i class="fa fa-chart-line"></i> Analytics</a>
      <a href="page4.html"><i class="fa fa-check-circle"></i> Completed</a>
      <a href="page5.html"><i class="fa fa-triangle-exclamation"></i> Backlogs</a>
      <a href="page6.html"><i class="fa fa-cubes"></i> WallDrop</a>
    </nav>
  </aside>

  <main class="main">
    <div class="page-header">
      <div class="page-title">Cloud Analytics</div>
      <div class="sync-status">
        <div id="syncDot" class="dot"></div>
        <span id="syncText">Syncing...</span>
      </div>
    </div>

    <div class="chart-grid">
      <div class="chart-card">
        <h3>Job Types Distribution</h3>
        <canvas id="typeChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Current Status Overview</h3>
        <canvas id="statusChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Postponed Stages (Backlog Depth)</h3>
        <canvas id="stageChart"></canvas>
      </div>
    </div>
  </main>
</div>

<script>
const API_URL = "/api";
let charts = {};

async function loadAndDraw() {
  try {
    const res = await fetch(API_URL);
    const records = await res.json();
    
    document.getElementById('syncDot').className = "dot online";
    document.getElementById('syncText').innerText = "Real-time Data";

    const active = records.filter(r => r.status !== 'Completed');
    const completed = records.filter(r => r.status === 'Completed');

    drawTypeChart(active);
    drawStatusChart(active, completed);
    drawStageChart(active);
    
  } catch (e) {
    document.getElementById('syncDot').className = "dot";
    document.getElementById('syncText').innerText = "Sync Error";
  }
}

function drawTypeChart(data) {
  const counts = {};
  data.forEach(r => counts[r.type] = (counts[r.type] || 0) + 1);

  if(charts.type) charts.type.destroy();
  charts.type = new Chart(document.getElementById('typeChart'), {
    type: 'pie',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        data: Object.values(counts),
        backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4']
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

function drawStatusChart(active, completed) {
  const statusCounts = {
    Active: active.filter(r => r.status === 'Active' || !r.status).length,
    Postponed: active.filter(r => r.status === 'Postponed').length,
    Completed: completed.length
  };

  if(charts.status) charts.status.destroy();
  charts.status = new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
      labels: Object.keys(statusCounts),
      datasets: [{
        data: Object.values(statusCounts),
        backgroundColor: ['#2563eb', '#f59e0b', '#10b981']
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

function drawStageChart(data) {
  const stages = {};
  data.forEach(r => {
    const s = r.postponeIndex || 0;
    stages[`Stage ${s}`] = (stages[`Stage ${s}`] || 0) + 1;
  });

  if(charts.stage) charts.stage.destroy();
  charts.stage = new Chart(document.getElementById('stageChart'), {
    type: 'bar',
    data: {
      labels: Object.keys(stages),
      datasets: [{
        label: 'Jobcards',
        data: Object.values(stages),
        backgroundColor: '#2563eb'
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
}

// Initial draw and sync every 60 seconds (Analytics doesn't need 30s)
loadAndDraw();
setInterval(loadAndDraw, 60000);
</script>
</body>
</html>